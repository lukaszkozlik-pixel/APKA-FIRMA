<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satelita - Kierunki</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #f4f4f4; display: flex; flex-direction: column; height: 100vh; }
        header { background: #004ba0; color: white; padding: 10px; display: flex; align-items: center; z-index: 1000; }
        .btn-back { background: none; border: none; color: white; font-size: 1.8rem; padding-right: 15px; cursor: pointer; }
        h1 { font-size: 1.2rem; margin: 0; flex-grow: 1; text-align: center; margin-right: 30px; }

        #map { height: 35%; width: 100%; z-index: 1; border-bottom: 2px solid #ccc; }
        
        .list-container { flex: 1; overflow-y: auto; padding: 10px; }
        
        .sat-card {
            background: white; margin-bottom: 10px; padding: 15px;
            border-radius: 8px; display: grid; 
            grid-template-columns: 1fr auto auto auto; /* 4 kolumny: nazwa, azymut, elewacja, skew */
            gap: 12px; align-items: center; border-left: 5px solid #004ba0; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Wyróżnienie Hotbirda i Astry */
        .sat-card.top-sat {
            background: #f0f7ff;
            border-left-color: #1a73e8;
            border-left-width: 8px;
        }

        .sat-card.active { border-left-color: #00c853; background: #f1f8e9; }
        
        .val-box { text-align: center; min-width: 50px; }
        .val-label { font-size: 0.65rem; color: #666; text-transform: uppercase; margin-bottom: 2px; }
        .val-num { font-size: 1rem; font-weight: bold; color: #1a73e8; }

        .phone-heading {
            width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 20px solid #00c853; filter: drop-shadow(0 0 2px black);
        }
    </style>
</head>
<body>

<header>
    <button class="btn-back" onclick="window.location.replace('../index.html')">&lt;</button>
    <h1>Ustawianie Satelity</h1>
</header>

<div id="map"></div>

<div class="list-container" id="sat-list">
    <div style="padding: 20px; text-align: center;">Szukam pozycji GPS...</div>
</div>

<script>
    let map, userMarker, headingMarker, currentLine;
    let userCoords = null;

    // Lista satelitów z flagą 'top' dla najważniejszych pozycji
    const satellites = [
        { name: "Hotbird 13.0°E", lon: 13.0, top: true },
        { name: "Astra 19.2°E", lon: 19.2, top: true },
        { name: "Eutelsat 16.0°E", lon: 16.0 },
        { name: "Eutelsat 9.0°E", lon: 9.0 },
        { name: "Astra 4.8°E", lon: 4.8 },
        { name: "Astra 28.2°E", lon: 28.2 },
        { name: "Thor 0.8°W", lon: -0.8 },
        { name: "Amos 4.0°W", lon: -4.0 },
        { name: "Hispasat 30.0°W", lon: -30.0 }
    ];

    document.addEventListener("deviceready", () => {
        navigator.geolocation.watchPosition(updatePos, err => console.error(err), { enableHighAccuracy: true });
    }, false);

    // Tryb testowy (przeglądarka)
    window.onload = () => { if(!window.cordova) navigator.geolocation.watchPosition(updatePos); };

    function updatePos(pos) {
        userCoords = [pos.coords.latitude, pos.coords.longitude];
        if (!map) {
            map = L.map('map').setView(userCoords, 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            userMarker = L.circleMarker(userCoords, { color: '#1a73e8', radius: 8, fillOpacity: 1 }).addTo(map);
            
            const headingIcon = L.divIcon({
                className: 'phone-heading-wrapper',
                html: '<div class="phone-heading" id="phone-arrow"></div>',
                iconSize: [20, 20], iconAnchor: [10, 10]
            });
            headingMarker = L.marker(userCoords, { icon: headingIcon }).addTo(map);
        } else {
            userMarker.setLatLng(userCoords);
            headingMarker.setLatLng(userCoords);
        }
        renderSatList();
    }

    // Kompas
    window.addEventListener('deviceorientationabsolute', e => {
        let heading = e.alpha || e.webkitCompassHeading;
        if (heading !== undefined) {
            const arrow = document.getElementById('phone-arrow');
            if (arrow) arrow.style.transform = `rotate(${heading}deg)`;
        }
    }, true);

    function renderSatList() {
        const list = document.getElementById("sat-list");
        if (!userCoords) return;
        list.innerHTML = "";

        // Sortowanie: te z flagą 'top' zawsze na górze
        const sortedSats = [...satellites].sort((a, b) => {
            if (a.top && !b.top) return -1;
            if (!a.top && b.top) return 1;
            return 0;
        });

        sortedSats.forEach(sat => {
            const az = calculateAzimuth(userCoords[0], userCoords[1], sat.lon);
            const el = calculateElevation(userCoords[0], userCoords[1], sat.lon);
            const sk = calculateSkew(userCoords[0], userCoords[1], sat.lon);

            const card = document.createElement('div');
            card.className = 'sat-card' + (sat.top ? ' top-sat' : '');
            
            card.onclick = () => drawSatLine(az, card);
            card.innerHTML = `
                <div style="font-weight:bold;">${sat.name}</div>
                <div class="val-box"><div class="val-label">Azymut</div><div class="val-num">${az}°</div></div>
                <div class="val-box"><div class="val-label">Elewacja</div><div class="val-num">${el}°</div></div>
                <div class="val-box"><div class="val-label">Skew</div><div class="val-num">${sk}°</div></div>
            `;
            list.appendChild(card);
        });
    }

    function drawSatLine(az, card) {
        document.querySelectorAll('.sat-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        if (currentLine) map.removeLayer(currentLine);
    
        // KOREKTA: W nawigacji 0° to Północ (góra). 
        // W matematyce JS 0° to Wschód (prawa).
        // Musimy odjąć 90 stopni i zmienić kierunek rotacji.
        const angleRad = (az - 90) * Math.PI / 180;
        
        const d = 0.005; // długość linii
        const endPoint = [
            userCoords[0] - d * Math.sin(angleRad), // Latitude
            userCoords[1] + d * Math.cos(angleRad)  // Longitude
        ];
    
        currentLine = L.polyline([userCoords, endPoint], { 
            color: '#00c853', 
            weight: 5, 
            dashArray: '5, 10' 
        }).addTo(map);
    
        map.setView(userCoords, 17);
    }

    // --- MATEMATYKA SATELITARNA ---

    function calculateAzimuth(lat, lon, satLon) {
        const phi = lat * Math.PI / 180;
        const dL = (lon - satLon) * Math.PI / 180;
        const az = Math.PI + Math.atan2(Math.tan(dL), Math.sin(phi));
        return Math.round((az * 180 / Math.PI) % 360);
    }

    function calculateElevation(lat, lon, satLon) {
        const phi = lat * Math.PI / 180;
        const dL = (lon - satLon) * Math.PI / 180;
        const R = 6371; // km
        const r = 42164; // promień orbity geostacjonarnej w km
        
        const num = Math.cos(phi) * Math.cos(dL) - (R / r);
        const den = Math.sqrt(1 - Math.pow(Math.cos(phi) * Math.cos(dL), 2));
        const el = Math.atan(num / den);
        return Math.round(el * 180 / Math.PI);
    }

    function calculateSkew(lat, lon, satLon) {
        const phi = lat * Math.PI / 180;
        const dL = (lon - satLon) * Math.PI / 180;
        const skewRad = Math.atan(Math.sin(dL) / Math.tan(phi));
        return Math.round(skewRad * 180 / Math.PI);
    }
</script>
</body>
</html>

