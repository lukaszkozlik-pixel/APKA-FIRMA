<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cennik Usług</title>
    <script src="../config.js"></script>
    <link rel="stylesheet" href="../style.css">
    <style>
        header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #1a73e8;
            color: white;
        }
        header h1 {
            margin: 0;
            font-size: 1.3rem;
            flex-grow: 1;
            text-align: center;
            margin-right: 40px;
        }

        .btn-back {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            font-weight: 300;
            padding: 5px 15px 5px 0;
                body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--text); }
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .item-list { padding: 15px; flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .price-item {
            background: var(--tile-bg); margin-bottom: 10px; padding: 15px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border: 2px solid transparent; transition: 0.2s;
            user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
            color: var(--text);
        }
        .price-item.selected { border-color: #1a73e8; background: #e8f0fe; }
        .price-item:active { background-color: #fce8e6; transition: background-color 0.8s; }
        .price-value { font-weight: bold; color: #1a73e8; }
        .qty { font-weight: bold; color: #1a73e8; margin-right: 5px; }
        .item-other { border: 2px dashed #1a73e8; color: #1a73e8; justify-content: center; font-weight: bold; margin-top: 20px; }

        .summary-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--tile-bg); color: var(--text); padding: 20px;
            border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center;
            z-index: 50;
        }
        .btn-done { background: #03dac6; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); justify-content: center; align-items: center; padding: 20px; z-index: 100;
        }
        .modal-content { background: var(--tile-bg); color: var(--text); padding: 20px; border-radius: 15px; width: 95%; max-width: 400px; }
        .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-modal { padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        
        .custom-form { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .custom-form input { padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
    </style>
</head>
<script>
// Motyw: kopiuj ustawienie z localStorage lub systemu
function applyTheme() {
    let theme = localStorage.getItem('theme');
    if (!theme) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    document.documentElement.setAttribute('data-theme', theme);
}
applyTheme();
</script>
<body>
    <div id="app">
        <header>
            <button class="btn-back" onclick="window.location.replace('../index.html')">◀</button>
            <h1>Cennik Instalacji</h1>
        </header>

        <div class="item-list" id="menu">
            <div class="price-item" onclick="addMountingPrice()" onmousedown="startPress(this)" onmouseup="endPress()" ontouchstart="startPress(this)" ontouchend="endPress()" oncontextmenu="return false;" data-name="Montaż">
                <div><span class="qty"></span><span>Montaż (podaj cenę)</span></div>
                <span class="price-value" id="mount-val">--- zł</span>
            </div>

            <div class="price-item item-other" onclick="openCustomModal()">+ Dodaj inne</div>
        </div>

        <div class="summary-bar">
            <div>Suma: <span id="total-price">0</span> zł</div>
            <button id="btn-submit" class="btn-done" onclick="showSummary()" disabled style="opacity: 0.5;">GOTOWE</button>
        </div>
    </div>
        
    <div id="modal-custom" class="modal">
        <div class="modal-content">
            <h3>Własna usługa</h3>
            <div class="custom-form">
                <input type="text" id="custom-name" placeholder="Nazwa">
                <input type="number" id="custom-price" placeholder="Cena (zł)" inputmode="decimal" step="0.01" onkeydown="if(['e', 'E', '+', '-'].includes(event.key)) event.preventDefault();">
            </div>
            <div class="modal-btns">
                <button class="btn-modal" onclick="closeCustomModal()" style="background:#eee;">Anuluj</button>
                <button class="btn-modal" onclick="addCustomItem()" style="background:#1a73e8; color:white;">Dodaj</button>
            </div>
        </div>
    </div>

    <div id="modal-input-prompt" class="modal">
        <div class="modal-content">
            <h3 id="prompt-title">Podaj wartość</h3>
            <div class="custom-form">
                <input type="number" id="prompt-value" inputmode="decimal" step="0.01" placeholder="0.00">
            </div>
            <div class="modal-btns">
                <button class="btn-modal" onclick="closeInputPrompt()" style="background:#eee;">Anuluj</button>
                <button class="btn-modal" id="prompt-confirm-btn" style="background:#1a73e8; color:white;">OK</button>
            </div>
        </div>
    </div>

    <div id="modal-summary" class="modal">
        <div class="modal-content">
            <h3>Podsumowanie:</h3>
            <ul id="summary-list" style="margin: 20px 0; list-style: none; padding: 0; max-height: 50vh; overflow-y: auto;"></ul>
            <hr>
            <h2 id="modal-total" style="text-align: center;"></h2>
            <div class="modal-btns">
                <button class="btn-modal" onclick="sendToReports()" style="background: #1a73e8; color: white; grid-column: span 2;">WYGENERUJ RAPORT</button>
                <button class="btn-modal" onclick="closeSummaryModal()" style="background: #70757a; color: white;">Wróć</button>
                <button class="btn-modal" onclick="resetAll()" style="background: #d93025; color: white;">Nowe</button>
            </div>
        </div>
    </div>

    <script>
        let total = 0;
        let selectedItems = [];
        let pressTimer;
        let isLongPress = false;
        
      

       const request = indexedDB.open(APP_CONFIG.DB_NAME, APP_CONFIG.DB_VERSION);

        request.onupgradeneeded = (e) => {
            const database = e.target.result;
            // Tworzymy wszystkie szuflady, aby baza była kompletna niezależnie od tego, który plik ją inicjuje
            if (!database.objectStoreNames.contains("raporty")) {
                database.createObjectStore("raporty", { keyPath: "id", autoIncrement: true });
            }
            if (!database.objectStoreNames.contains("magazyn")) {
                database.createObjectStore("magazyn", { keyPath: "name" });
            }
            if (!database.objectStoreNames.contains("settings")) {
                database.createObjectStore("settings", { keyPath: "key" });
            }
        };

        request.onsuccess = (e) => {
            db = e.target.result;
        };

        // Poprawiona funkcja addToUsage (od linii ok. 154)
        async function addToUsage(items) {
            if (!db) return;
            // Zabezpieczenie przed błędem, jeśli tabela jakimś cudem nie powstała
            if (!db.objectStoreNames.contains("magazyn")) return console.error("Brak tabeli magazyn!");

            const tx = db.transaction("magazyn", "readwrite");
            const store = tx.objectStore("magazyn");

            for (const item of items) {
                if (item.qty <= 0) continue;
                const req = store.get(item.name);
                req.onsuccess = (e) => {
                    const data = e.target.result || { name: item.name, quantity: 0 };
                    data.quantity += item.qty;
                    store.put(data);
                };
            }
        }



        // --- FUNKCJA WSPOMAGAJĄCA KLAWIATURĘ NUMERYCZNĄ ZAMIAST PROMPT ---
        function openInputPrompt(title, defaultValue, callback) {
            document.getElementById('prompt-title').innerText = title;
            const input = document.getElementById('prompt-value');
            input.value = defaultValue;
            document.getElementById('modal-input-prompt').style.display = 'flex';
            input.focus();
            
            document.getElementById('prompt-confirm-btn').onclick = function() {
                const val = parseFloat(input.value.replace(',', '.'));
                closeInputPrompt();
                if (!isNaN(val)) callback(val);
            };
        }

        function closeInputPrompt() {
            document.getElementById('modal-input-prompt').style.display = 'none';
        }

        function updateDisplay() {
            document.getElementById('total-price').innerText = total;
            document.querySelectorAll('.price-item').forEach(div => {
                const name = div.getAttribute('data-name');
                if(!name) return;
                const item = selectedItems.find(i => i.name === name);
                const qtySpan = div.querySelector('.qty');
                const valSpan = div.querySelector('.price-value');
                
                if (item) {
                    div.classList.add('selected');
                    let unit = name.includes("Kabel") ? "m x " : "x ";
                    qtySpan.innerText = item.qty + unit;
                    if(name === "Montaż") valSpan.innerText = item.price + " zł";
                } else {
                    div.classList.remove('selected');
                    qtySpan.innerText = "";
                    if(name === "Montaż") valSpan.innerText = "--- zł";
                }
            });
            const btn = document.getElementById('btn-submit');
            btn.disabled = total <= 0;
            btn.style.opacity = total > 0 ? "1" : "0.5";
        }

        window.onload = function() { initPrices(); };

        async function initPrices() {
            const urlSerwera = 'https://gist.githubusercontent.com/lukaszkozlik-pixel/cc9860262022f28a759d1790020381fe/raw/uslugi.json';
            const localData = localStorage.getItem('cachedServices');
            if (localData) renderServices(JSON.parse(localData));

            try {
                const response = await fetch(urlSerwera + '?t=' + Date.now());
                if (response.ok) {
                    const freshServices = await response.json();
                    localStorage.setItem('cachedServices', JSON.stringify(freshServices));
                    document.querySelectorAll('.standard-item').forEach(el => el.remove());
                    renderServices(freshServices);
                }
            } catch (error) { console.log("Tryb offline."); }
        }

        function renderServices(services) {
            const menuContainer = document.getElementById('menu');
            services.forEach(service => {
                const div = document.createElement('div');
                div.className = 'price-item standard-item';
                div.setAttribute('data-name', service.name);
                div.setAttribute('data-price', service.price);
                const isKabel = service.name.toLowerCase().includes('kabel');
                div.onclick = function() { isKabel ? addCableFromJSON(this) : addItem(this); };
                div.onmousedown = function() { startPress(this); };
                div.onmouseup = function() { endPress(); };
                div.ontouchstart = function() { startPress(this); };
                div.ontouchend = function() { endPress(); };
                div.innerHTML = `<div><span class="qty"></span><span>${service.name}</span></div>
                                 <span class="price-value">${service.price} zł${isKabel ? '/m' : ''}</span>`;
                menuContainer.insertBefore(div, document.querySelector('.item-other'));
            });
            updateDisplay();
        }

        function addCableFromJSON(element) {
            if (isLongPress) return;
            const name = element.getAttribute('data-name');
            const unitPrice = parseFloat(element.getAttribute('data-price'));
            
            openInputPrompt(`Ile metrów: ${name}?`, "1", function(qty) {
                if (qty > 0) {
                    let item = selectedItems.find(i => i.name === name);
                    if (item) item.qty += qty; else selectedItems.push({ name: name, price: unitPrice, qty: qty });
                    total = Math.round((total + (unitPrice * qty)) * 100) / 100;
                    updateDisplay();
                }
            });
        }

        function addItem(element) {
            if (isLongPress) return;
            const name = element.getAttribute('data-name');
            const price = parseFloat(element.getAttribute('data-price'));
            let item = selectedItems.find(i => i.name === name);
            if (item) item.qty++; else selectedItems.push({ name, price, qty: 1 });
            total = Math.round((total + price) * 100) / 100;
            updateDisplay();
        }

        function addMountingPrice() {
            if (isLongPress) return;
            openInputPrompt("Podaj cenę montażu:", "", function(price) {
                if (price > 0) {
                    const name = "Montaż";
                    let item = selectedItems.find(i => i.name === name);
                    if (item) { item.qty++; total += price; } 
                    else { selectedItems.push({ name, price, qty: 1 }); total += price; }
                    total = Math.round(total * 100) / 100;
                    updateDisplay();
                }
            });
        }

        function removeItemAll(element) {
            const name = element.getAttribute('data-name');
            let idx = selectedItems.findIndex(i => i.name === name);
            if (idx > -1) {
                total -= (selectedItems[idx].price * selectedItems[idx].qty);
                selectedItems.splice(idx, 1);
            }
            total = Math.round(total * 100) / 100;
            updateDisplay();
        }

        function startPress(element) {
            isLongPress = false;
            pressTimer = setTimeout(() => { 
                isLongPress = true; 
                removeItemAll(element); 
                if(navigator.vibrate) navigator.vibrate(60); 
            }, 700);
        }
        function endPress() { clearTimeout(pressTimer); }

        function openCustomModal() { document.getElementById('modal-custom').style.display = 'flex'; }
        function closeCustomModal() { document.getElementById('modal-custom').style.display = 'none'; }
        function addCustomItem() {
            const name = document.getElementById('custom-name').value.trim();
            const price = parseFloat(document.getElementById('custom-price').value);
            if (name && !isNaN(price)) {
                selectedItems.push({ name, price, qty: 1 });
                total = Math.round((total + price) * 100) / 100;
                updateDisplay();
                document.getElementById('custom-name').value = '';
                document.getElementById('custom-price').value = '';
                closeCustomModal();
            }
        }

        function showSummary() {
            const list = document.getElementById('summary-list');
            list.innerHTML = '';
            selectedItems.forEach(item => {
                list.innerHTML += `<li style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>${item.name} x${item.qty}</span>
                    <span>${(item.price * item.qty).toFixed(2)} zł</span>
                </li>`;
            });
            document.getElementById('modal-total').innerText = `Razem: ${total.toFixed(2)} zł`;
            document.getElementById('modal-summary').style.display = 'flex';
        }

        function generateSummaryText() {
            if (selectedItems.length === 0) return "Brak wybranych pozycji.";
            const now = new Date();
            const dateStr = now.toLocaleDateString('pl-PL', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            let text = `Data: ${dateStr}\n\n--------------------------\n\n`;
            selectedItems.forEach((item, index) => {
                const linePrice = (item.price * item.qty).toFixed(2);
                const unit = item.name.toLowerCase().includes('kabel') ? 'm' : 'szt.';
                text += `${index + 1}. ${item.name}\n   ${item.qty} ${unit} x ${item.price} zł = ${linePrice} zł\n`;
            });
            text += `\n--------------------------\nSUMA DO ZAPŁATY: ${total.toFixed(2)} zł\n--------------------------\n`;
            return text;
        }

        async function sendToReports() {
            await addToUsage(selectedItems); // Rejestrujemy zużycie
            localStorage.setItem('pending_report_text', generateSummaryText());
            window.location.replace("raporty.html");
        }

        function closeSummaryModal() { document.getElementById('modal-summary').style.display = 'none'; }
        function resetAll() { total = 0; selectedItems = []; updateDisplay(); closeSummaryModal(); }
    </script>
</body>
</html>