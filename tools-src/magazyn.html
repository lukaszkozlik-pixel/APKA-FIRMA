<!DOCTYPE html>
<html lang="pl">
<head>
    <link rel="stylesheet" href="../style.css">
    <script src="../config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZuÅ¼ycie MiesiÄ™czne</title>
    <style>
        .usage-card {
            background: var(--tile-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--tile-shadow);
        }
        .qty-badge {
            background: #1a73e8;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .btn-reset {
            background: var(--danger, #ea4335);
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header style="background: #fbbc04; color: #202124; padding: 15px; display: flex; align-items: center;">
        <button onclick="window.location.href='../index.html'" style="background:none; border:none; font-size:1.5rem;">â—€</button>
        <h1 style="flex-grow:1; text-align:center; font-size:1.2rem; margin:0;">UÅ¼yte w tym miesiÄ…cu</h1>
    
    </header>
   


    <div style="padding: 15px;">
        <button class="btn-reset" style="background-color: rgb(30, 121, 240);" onclick="copyMagazynToClipboard()">KOPIUJ MAGAZYN DO SCHOWKA ðŸ“‹</button>
        <button class="btn-reset" style="margin-bottom: 24px;" onclick="resetMonth()">ZAMKNIJ MIESIÄ„C / WYCZYÅšÄ†</button>
        <div id="usageList"></div>
    </div>

    <script>
        let db;
        // UÅ¼ywamy wersji i nazwy z config.js
        const request = indexedDB.open(APP_CONFIG.DB_NAME, APP_CONFIG.DB_VERSION);

        request.onupgradeneeded = (e) => {
            const database = e.target.result;
            // MUSIMY zadeklarowaÄ‡ wszystko, co moÅ¼e istnieÄ‡ w aplikacji
            if (!database.objectStoreNames.contains("raporty")) {
                database.createObjectStore("raporty", { keyPath: "id", autoIncrement: true });
            }
            if (!database.objectStoreNames.contains("magazyn")) {
                database.createObjectStore("magazyn", { keyPath: "name" });
            }
            if (!database.objectStoreNames.contains("settings")) {
                database.createObjectStore("settings", { keyPath: "key" });
            }
        };

        request.onsuccess = (e) => {
            db = e.target.result;
            loadUsage();
        };

        function loadUsage() {
            const list = document.getElementById('usageList');
            const tx = db.transaction("magazyn", "readonly");
            const store = tx.objectStore("magazyn");
            
            store.getAll().onsuccess = e => {
                const items = e.target.result;
                if(items.length === 0) {
                    list.innerHTML = "<p style='text-align:center; color:#999;'>Nie sprzedano jeszcze Å¼adnych towarÃ³w w tym miesiÄ…cu.</p>";
                    return;
                }
                list.innerHTML = items.map(item => `
                    <div class="usage-card">
                        <div style="font-weight:bold">${item.name}</div>
                        <div class="qty-badge">${item.quantity || 0}</div>
                    </div>
                `).join('');
            };
        }

    function resetMonth() {
        if (!confirm("Czy na pewno wyczyÅ›ciÄ‡ caÅ‚e zuÅ¼ycie z tego miesiÄ…ca?")) return;
        
        const tx = db.transaction("magazyn", "readwrite");
        const store = tx.objectStore("magazyn");
        const req = store.clear();
        
        req.onsuccess = () => {
            if (typeof showToast === 'function') showToast("Magazyn wyczyszczony");
            loadUsage();
        };
    }

        async function copyMagazynToClipboard() {
            const tx = db.transaction("magazyn", "readonly");
            const store = tx.objectStore("magazyn");
            const allItems = [];
            store.getAll().onsuccess = (e) => {
                const items = e.target.result;
                formatAndCopy(items);
            };
}

    function formatAndCopy(data) {
        if (data.length === 0) {
            alert("Magazyn jest pusty - nie ma czego kopiowaÄ‡.");
            return;
        }

        let content = "STAN MAGAZYNU - wykorzystane\n";
        content += "Data: " + new Date().toLocaleString() + "\n";
        content += "---------------------------\n";

        data.forEach(item => {
            content += `â€¢ ${item.name}: ${item.quantity || 0}\n`;
        });

        content += "---------------------------";

        // PrÃ³ba skopiowania do schowka
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(content).then(() => {
                // Wykorzystujemy TwojÄ… funkcjÄ™ showToast z index.html, jeÅ›li jest dostÄ™pna
                if (typeof showToast === 'function') {
                    showToast("Skopiowano do schowka! ðŸ“‹");
                } else {
                    alert("Skopiowano do schowka!");
                }
            }).catch(err => {
                console.error("BÅ‚Ä…d kopiowania:", err);
                alert("Nie udaÅ‚o siÄ™ skopiowaÄ‡ do schowka.");
            });
        } else {
            // Fallback dla starszych przeglÄ…darek
            const textArea = document.createElement("textarea");
            textArea.value = content;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert("Skopiowano do schowka (metoda alternatywna)!");
            } catch (err) {
                alert("Twoja przeglÄ…darka nie wspiera kopiowania.");
            }
            document.body.removeChild(textArea);
        }
    }
    </script>
</body>
</html>