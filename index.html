<!DOCTYPE html>
<html lang="pl">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>

        /* Toast aktualizacji */
        #update-toast {
            display: none; position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%); background: #323232; color: white;
            padding: 12px 24px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            z-index: 10000; align-items: center; gap: 15px; font-size: 0.9rem;
            animation: slideInUp 0.4s ease-out;
        }
        @keyframes slideInUp { from { bottom: -50px; opacity: 0; } to { bottom: 80px; opacity: 1; } }
        #update-toast button { background: #fbbc05; border: none; color: #202124; padding: 5px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }
    </style>
    <script>
        window.addEventListener('beforeinstallprompt', (e) => {
        // Zapobiega domyÅ›lnemu zachowaniu Chrome (opcjonalne)
        // e.preventDefault(); 
        
        // MoÅ¼esz tutaj np. pokazaÄ‡ wÅ‚asny przycisk "ZAINSTALUJ APLIKACJÄ˜"
        console.log('Strona jest gotowa do instalacji jako PWA');
        });

        // Service Worker - rejestracja i auto-update
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js', { scope: './' }).then(reg => {
                    console.log('Service Worker zarejestrowany pomyÅ›lnie');
                    
                    let lastKnownVersion = null;
                    
                    // Pobierz bieÅ¼Ä…cÄ… wersjÄ™ z manifest.json
                    async function getCurrentVersion() {
                        try {
                            const response = await fetch('manifest.json', { cache: 'no-store' });
                            const manifest = await response.json();
                            return manifest.version || '1.0.0';
                        } catch (err) {
                            console.warn('Nie mogÄ™ pobraÄ‡ wersji:', err);
                            return null;
                        }
                    }
                    
                    // Pobierz wersjÄ™ przy start
                    getCurrentVersion().then(version => {
                        lastKnownVersion = version;
                        console.log(`Aktualna wersja aplikacji: ${version}`);
                    });
                    
                    // Sprawdzanie wersji co 10 sekund
                    setInterval(async () => {
                        const newVersion = await getCurrentVersion();
                        if (newVersion && lastKnownVersion && newVersion !== lastKnownVersion) {
                            console.log(`Nowa wersja dostÄ™pna: ${newVersion}`);
                            lastKnownVersion = newVersion;
                            document.getElementById('update-toast').style.display = 'flex';
                        }
                    }, 10000);
                    
                    // NasÅ‚uchiwanie na nowÄ… wersjÄ™ (fallback)
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('DostÄ™pna nowa wersja - Service Worker!');
                                document.getElementById('update-toast').style.display = 'flex';
                            }
                        });
                    });
                }).catch(err => {
                    console.error('BÅ‚Ä…d rejestracji Service Workera:', err);
                });
            });
        }
    </script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instalator Pro</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="update-toast">
        <span>Nowa wersja jest dostÄ™pna!</span>
        <button onclick="location.reload()">ODÅšWIEÅ»</button>
    </div>

    <div id="offline-banner" style="display:none;position:fixed;top:0;left:0;width:100vw;background:#d93025;color:white;text-align:center;padding:12px 0;z-index:10001;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.15);">
        Brak poÅ‚Ä…czenia z internetem â€“ aplikacja dziaÅ‚a w trybie offline.
    </div>

    <div id="ios-install-banner" style="display:none;position:fixed;bottom:0;left:0;width:100vw;background:#fffbe6;color:#202124;text-align:center;padding:14px 10px 14px 50px;z-index:10002;font-weight:500;box-shadow:0 -2px 8px rgba(0,0,0,0.10);border-top:2px solid #fbbc05;font-size:1rem;align-items:center;">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/3e/IOS_Share_icon.png" alt="UdostÄ™pnij" style="height:24px;vertical-align:middle;position:absolute;left:16px;top:14px;">
        Aby zainstalowaÄ‡ aplikacjÄ™ na iPhonie: kliknij <b>UdostÄ™pnij</b> <img src="https://upload.wikimedia.org/wikipedia/commons/3/3e/IOS_Share_icon.png" style="height:20px;vertical-align:middle;"> i wybierz <b>Do ekranu poczÄ…tkowego</b>.
        <button onclick="this.parentElement.style.display='none'" style="margin-left:20px;background:#fbbc05;border:none;padding:4px 16px;border-radius:16px;font-weight:bold;cursor:pointer;">Zamknij</button>
    </div>

    <div id="error-banner" style="display:none;position:fixed;top:48px;left:50%;transform:translateX(-50%);background:#d93025;color:white;padding:12px 24px;border-radius:8px;z-index:10003;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.15);max-width:90vw;">
        <span id="error-message"></span>
        <button onclick="this.parentElement.style.display='none'" style="margin-left:18px;background:#fff;color:#d93025;border:none;padding:2px 12px;border-radius:12px;font-weight:bold;cursor:pointer;">Zamknij</button>
    </div>

    <div id="app">
        <header>
            <h1>NiezbÄ™dnik Instalatora</h1>
        </header>

        <main class="grid-container">
           
            <div class="tile" onclick="location.href='tools-src/nadajniki.html'">
                <span class="icon">ğŸ—¼</span>
                <span class="label">Kierunki do nadajnikÃ³w DVB-T</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/bibliotekaDVBT.html'">
                <span class="icon">ğŸ“º</span>
                <span class="label">Baza wiedzy DVB-T</span>
            </div>
             <div class="tile" onclick="location.href='tools-src/satelity.html'">
                <span class="icon">ğŸ“¡</span>
                <span class="label">Kalkulator azymutu SAT</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/bibliotekaSAT.html'">
                <span class="icon">ğŸ›°ï¸</span>
                <span class="label">Baza wiedzy SAT</span>
            </div>
           
            
            <div class="tile" onclick="location.href='tools-src/instrukcje.html'">
                <span class="icon">ğŸ“–</span>
                <span class="label">Instrukcje obsÅ‚ugi i dekoderÃ³w</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/cennik.html'">
                <span class="icon">ğŸ’°</span>
                <span class="label">Kalkulator usÅ‚ug i cennik</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/Jednostki.html'">
                <span class="icon">â†”ï¸</span>
                <span class="label">Przelicznik jednostek sygnaÅ‚u</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/internet.html'">
                <span class="icon">ğŸŒ</span>
                <span class="label">Internet, kable i LTE</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/notatki.html'">
                <span class="icon">ğŸ“</span>
                <span class="label">Notatnik instalatora</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/raporty.html'">
                <span class="icon">ğŸ“‹</span>
                <span class="label">Raporty z instalacji</span>
            </div>
        </main>

        <footer style="text-align: center; color: gray; font-size: 10px; padding: 10px;">
            v<span id="app-version">1.x</span>, <span id="app-status">tryb sprawdzania...</span>
        </footer>
    </div>
</body>

    <script>
        let backClickCounter = 0;

        // Aplikacja nie korzysta z Cordovy â€” inicjalizujemy przy zaÅ‚adowaniu strony
        window.addEventListener('load', onDeviceReady);
        
        function onDeviceReady() {
            // 1. WERSJA - automatycznie pobierana z manifest.json lub ze zmiennej CACHE_NAME w sw.js
            async function setAppVersion() {
                const el = document.getElementById('app-version');
                if (!el) return;
                // 1) SprÃ³buj pobraÄ‡ manifest.json i odczytaÄ‡ pole `version`
                try {
                    const r = await fetch('manifest.json', {cache: 'no-store'});
                    if (r.ok) {
                        const m = await r.json();
                        if (m.version) { el.innerText = m.version; return; }
                    }
                } catch(e){}
                // 2) Fallback: sprÃ³buj odczytaÄ‡ sw.js i dopasowaÄ‡ wersjÄ™ z CACHE_NAME
                try {
                    const r2 = await fetch('sw.js', {cache: 'no-store'});
                    if (r2.ok) {
                        const txt = await r2.text();
                        const re = /CACHE_NAME\s*=\s*['"]([a-zA-Z0-9\-_.]*v?(\d+(?:\.\d+)+))['"]/i;
                        const m = txt.match(re);
                        if (m && m[2]) { el.innerText = m[2]; return; }
                    }
                } catch(e){}
                // 3) Ostateczny fallback
                el.innerText = '1.0.0';
            }
            setAppVersion();
        
            const statusSpan = document.getElementById('app-status');
        
            // 2. STATUS SIECI
            function updateOnlineStatus() {
                if (navigator.onLine) {
                    statusSpan.innerText = "Tryb ONLINE gotowy";
                    statusSpan.style.color = "#03dac6";
                    document.getElementById('offline-banner').style.display = 'none';
                } else {
                    statusSpan.innerText = "Tryb OFFLINE gotowy";
                    statusSpan.style.color = "gray";
                    document.getElementById('offline-banner').style.display = 'block';
                }
            }
            updateOnlineStatus();
        
            document.addEventListener("offline", updateOnlineStatus, false);
            document.addEventListener("online", updateOnlineStatus, false);
        
            // 3. TEST POÅÄ„CZENIA Z INTERNETEM (opcjonalnie, moÅ¼na zostawiÄ‡ tylko navigator.onLine)
            function testInternetConnection() {
                fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' })
                    .then(() => {
                        statusSpan.innerText = "Tryb ONLINE gotowy";
                        statusSpan.style.color = "#03dac6";
                    })
                    .catch(() => {
                        statusSpan.innerText = "Tryb OFFLINE gotowy";
                        statusSpan.style.color = "gray";
                    });
            }
            testInternetConnection();

            // 4. UKRYTY PRYCISK DO RESETU - licznik klikniÄ™Ä‡ w stopkÄ™
            const footer = document.querySelector('footer');
            if (footer) {
                footer.style.cursor = 'pointer';
                footer.setAttribute('title', 'Kliknij kilka razy, aby zresetowaÄ‡ aplikacjÄ™');

                footer.addEventListener('click', () => {
                    backClickCounter++;
                    // opcjonalnie pokazujemy krÃ³tkie powiadomienie
                    showToast(`KlikniÄ™cia: ${backClickCounter}/5`);
                    if (backClickCounter >= 5) {
                        // potwierdzenie uÅ¼ytkownika przed trwaÅ‚ym usuniÄ™ciem
                        if (confirm('Czy na pewno chcesz zresetowaÄ‡ aplikacjÄ™? To usunie wszystkie dane i cache.')) {
                            // usuÅ„ cache'y service workera
                            if ('caches' in window) {
                                caches.keys().then(names => {
                                    names.forEach(name => caches.delete(name));
                                });
                            }
                            // wyrejestruj service workera (jeÅ›li jest)
                            if (navigator.serviceWorker && navigator.serviceWorker.getRegistrations) {
                                navigator.serviceWorker.getRegistrations().then(regs => {
                                    regs.forEach(r => r.unregister());
                                }).catch(()=>{});
                            }
                            // wyczyÅ›Ä‡ localStorage
                            try { localStorage.clear(); } catch(e) {}
                            // zresetuj licznik i przeÅ‚aduj stronÄ™
                            backClickCounter = 0;
                            location.reload();
                        } else {
                            backClickCounter = 0; // anulowano, resetujemy licznik
                        }
                    }
                });

                // Zeruj licznik kiedy uÅ¼ytkownik opuszcza aplikacjÄ™ lub ukrywa kartÄ™
                window.addEventListener('pagehide', () => { backClickCounter = 0; });
                window.addEventListener('beforeunload', () => { backClickCounter = 0; });
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) backClickCounter = 0;
                });
            }
        }


        
        // Nasza wÅ‚asna, darmowa funkcja powiadomienia na ekranie
        function showToast(message) {
            // Usuwamy stare powiadomienie jeÅ›li jeszcze istnieje
            const oldToast = document.getElementById('custom-toast');
            if (oldToast) oldToast.remove();
        
            const statusDiv = document.createElement('div');
            statusDiv.id = 'custom-toast';
            statusDiv.style = "position:fixed; bottom:50px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:12px 25px; border-radius:25px; z-index:9999; font-size:14px; white-space:nowrap; border: 1px solid #444;";
            statusDiv.innerText = message;
            document.body.appendChild(statusDiv);
        
            // Animacja znikania
            setTimeout(() => {
                statusDiv.style.opacity = '0';
                statusDiv.style.transition = 'opacity 0.5s ease';
                setTimeout(() => statusDiv.remove(), 500);
            }, 2000);
        }

        function showOfflineBanner(show) {
            const banner = document.getElementById('offline-banner');
            if (show) {
                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
            }
        }

        function showIosInstallBanner() {
            const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            if (isIos && !isStandalone) {
                document.getElementById('ios-install-banner').style.display = 'block';
            }
        }
        window.addEventListener('load', showIosInstallBanner);
    </script>
</html>