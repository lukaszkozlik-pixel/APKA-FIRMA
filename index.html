<!DOCTYPE html>
<html lang="pl">

<head>
    <script src="config.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script>
        // Ustaw zawsze motyw jasny
        window.addEventListener('DOMContentLoaded', () => {
            document.documentElement.setAttribute('data-theme', 'light');
        });

        // Deklarujemy zmiennÄ… globalnie, aby updateApp() miaÅ‚a do niej dostÄ™p
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    console.log('SW dziaÅ‚a w trybie: Najpierw SieÄ‡');
                });
            });
        }

        async function initApp() {
            const pin = sessionStorage.getItem('user_pin');
            const modal = document.getElementById('loginModal');
            const modalTitle = document.querySelector('#loginModal h2');
            const inputField = document.getElementById('pinInput');

            if (!pin) {
                modal.style.display = 'flex';

                try {
                    // Sprawdzamy stan Sejfu przy starcie
                    const SECURE_DB_NAME = "InstalatorSecureDB";
                    const dbSecure = await openDB(SECURE_DB_NAME, 1);

                    const encReports = await getAllFromStore(dbSecure, "raporty");
                    const encMagazyn = await getAllFromStore(dbSecure, "magazyn");

                    // JeÅ›li sejf jest pusty -> tryb tworzenia
                    if (encReports.length === 0 && encMagazyn.length === 0) {
                        if (modalTitle) {
                            modalTitle.innerText = "TWORZENIE NOWEGO PINU";
                            modalTitle.style.color = "#1a73e8";
                        }
                        if (inputField) {
                            inputField.placeholder = "Ustal min. 4 znaki";
                        }
                    } else {
                        // Sejf ma dane -> zwykÅ‚e logowanie
                        if (modalTitle) modalTitle.innerText = "Podaj PIN";
                        if (inputField) inputField.placeholder = "Wpisz swÃ³j PIN";
                    }
                } catch (err) {
                    console.error("BÅ‚Ä…d sprawdzania bazy:", err);
                }
            } else {
                modal.style.display = 'none';
            }
        }

    </script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="crypto.js"></script>
    <script>
        // index.html - Nowa wersja logiki
        async function unlockApp() {
            const inputField = document.getElementById('pinInput');
            const inputPin = inputField.value;
            const modalTitle = document.querySelector('#loginModal h2');

            if (!inputPin || inputPin.length < 4) {
                alert("PIN musi mieÄ‡ co najmniej 4 znaki.");
                return;
            }

            try {
                const SECURE_DB_NAME = "InstalatorSecureDB";
                const TEMP_DB_NAME = "InstalatorDB";
                const dbSecure = await openDB(SECURE_DB_NAME, 1);

                const encReports = await getAllFromStore(dbSecure, "raporty");
                const encMagazyn = await getAllFromStore(dbSecure, "magazyn");

                // --- SCENARIUSZ: TWORZENIE NOWEGO PINU ---
                if (encReports.length === 0 && encMagazyn.length === 0) {
                    if (!window.tempFirstPin) {
                        window.tempFirstPin = inputPin;
                        inputField.value = "";
                        if (modalTitle) {
                            modalTitle.innerText = "POTWIERDÅ¹ NOWY PIN";
                            modalTitle.style.color = "#34a853";
                        }
                        inputField.placeholder = "Wpisz go jeszcze raz";
                        return;
                    }

                    if (window.tempFirstPin !== inputPin) {
                        alert("PIN-y nie sÄ… identyczne! SprÃ³buj ponownie.");
                        window.tempFirstPin = null;
                        if (modalTitle) modalTitle.innerText = "TWORZENIE NOWEGO PINU";
                        inputField.value = "";
                        return;
                    }

                    sessionStorage.setItem('user_pin', inputPin);
                    alert("PIN utworzony pomyÅ›lnie.");
                    document.getElementById('loginModal').style.display = 'none';
                    return;
                }

                // --- SCENARIUSZ: LOGOWANIE ---
                const cryptoKey = await EncryptionTool.getDerivedKey(inputPin);
                let testRecord = encReports.length > 0 ? encReports[0] : encMagazyn[0];
                const decryptedData = await EncryptionTool.decrypt(testRecord.payload, cryptoKey);

                if (decryptedData === null) {
                    alert("BÅ‚Ä™dny PIN!");
                    inputField.value = "";
                    return;
                }

                const reports = [];
                for (const item of encReports) {
                    const dec = await EncryptionTool.decrypt(item.payload, cryptoKey);
                    if (dec) { dec.id = item.id; reports.push(dec); }
                }

                const magazyn = [];
                for (const item of encMagazyn) {
                    const dec = await EncryptionTool.decrypt(item.payload, cryptoKey);
                    if (dec) { dec.id = item.id; magazyn.push(dec); }
                }

                await new Promise(res => {
                    const req = indexedDB.deleteDatabase(TEMP_DB_NAME);
                    req.onsuccess = res; req.onerror = res;
                });

                const dbTemp = await openDB(TEMP_DB_NAME, 1);
                const tx = dbTemp.transaction(["raporty", "magazyn"], "readwrite");
                reports.forEach(r => tx.objectStore("raporty").put(r));
                magazyn.forEach(m => tx.objectStore("magazyn").put(m));

                tx.oncomplete = () => {
                    sessionStorage.setItem('user_pin', inputPin);
                    document.getElementById('loginModal').style.display = 'none';
                };

            } catch (err) {
                console.error(err);
                alert("BÅ‚Ä…d autoryzacji.");
            }
        }

        async function lockAndExit() {
            const pin = sessionStorage.getItem('user_pin');
            if (!pin) return;

            try {
                console.time("Szyfrowanie");
                const cryptoKey = await EncryptionTool.getDerivedKey(pin);

                // 1. Pobierz dane z bazy roboczej
                const dbTemp = await openDB("InstalatorDB", 6);
                const reports = await getAllFromStore(dbTemp, "raporty");
                const magazyn = await getAllFromStore(dbTemp, "magazyn");

                // 2. OtwÃ³rz Sejf
                const dbSecure = await openDB("InstalatorSecureDB", 1);
                const txSec = dbSecure.transaction(["raporty", "magazyn"], "readwrite");

                // CzyÅ›cimy Sejf przed nowym zapisem
                await txSec.objectStore("raporty").clear();
                await txSec.objectStore("magazyn").clear();

                // 3. Szyfrujemy RAPORTY (ID zostaje jawne, reszta w payload)
                for (const item of reports) {
                    const encrypted = await EncryptionTool.encrypt(item, cryptoKey);
                    txSec.objectStore("raporty").put({ id: item.id, payload: encrypted });
                }

                // 4. Szyfrujemy MAGAZYN (ID zostaje jawne, NAZWA i ILOÅšÄ† w payload)
                for (const item of magazyn) {
                    const encrypted = await EncryptionTool.encrypt(item, cryptoKey);
                    txSec.objectStore("magazyn").put({ id: item.id, payload: encrypted });
                }

                txSec.oncomplete = () => {
                    console.timeEnd("Szyfrowanie");
                    // Kasujemy bazÄ™ roboczÄ… i wylogowujemy
                    indexedDB.deleteDatabase("InstalatorDB");
                    sessionStorage.removeItem('user_pin');
                    alert("Wszystkie dane zostaÅ‚y zaszyfrowane i ukryte.");
                    location.reload();
                };
            } catch (err) {
                console.error(err);
                alert("BÅ‚Ä…d podczas zamykania sejfu.");
            }
        }
        // Funkcje pomocnicze
        function openDB(name, version) {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(name, version);
                req.onupgradeneeded = e => {
                    const db = e.target.result;
                    // Obie bazy (robocza i sejf) uÅ¼ywajÄ… teraz ID jako klucza
                    if (!db.objectStoreNames.contains("raporty")) {
                        db.createObjectStore("raporty", { keyPath: "id", autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains("magazyn")) {
                        db.createObjectStore("magazyn", { keyPath: "id", autoIncrement: true });
                    }
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        function getAllFromStore(db, storeName) {
            return new Promise(res => {
                const tx = db.transaction(storeName, "readonly");
                tx.objectStore(storeName).getAll().onsuccess = e => res(e.target.result);
            });
        }

    </script>
    <title>Instalator Pro</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!--skrypt pierwszego LOGOWWNIA-->
    <div id="loginModal"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
        <div
            style="background:white; padding:30px; border-radius:20px; text-align:center; width:90%; max-width:350px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
            <div style="font-size:50px; margin-bottom:10px;">ğŸ”</div>
            <h2 style="margin:0 0 10px 0; color:#1a73e8;">Sejf Danych</h2>
            <p style="color:#666; font-size:14px; margin-bottom:20px;">WprowadÅº PIN, aby odszyfrowaÄ‡ bazÄ™ raportÃ³w.</p>
            <input type="password" id="pinInput" inputmode="numeric" placeholder="PIN"
                style="width:100%; padding:15px; font-size:24px; text-align:center; border:2px solid #eee; border-radius:12px; margin-bottom:20px;">
            <button onclick="unlockApp()"
                style="width:100%; padding:15px; background:#1a73e8; color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">ODBLOKUJ</button>
        </div>
    </div>
    <!--skrypt LOGOWWNIA-->

    <div id="offline-banner"
        style="display:none;position:fixed;top:0;left:0;width:100vw;background:#d93025;color:white;text-align:center;padding:12px 0;z-index:10001;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.15);">
        Brak poÅ‚Ä…czenia z internetem â€“ aplikacja dziaÅ‚a w trybie offline.
    </div>

    <div id="ios-install-banner"
        style="display:none;position:fixed;bottom:0;left:0;width:100vw;background:#fffbe6;color:#202124;text-align:center;padding:14px 10px 14px 50px;z-index:10002;font-weight:500;box-shadow:0 -2px 8px rgba(0,0,0,0.10);border-top:2px solid #fbbc05;font-size:1rem;align-items:center;">
        Aby zainstalowaÄ‡ aplikacjÄ™ na iPhonie: kliknij <b>UdostÄ™pnij</b> i wybierz <b>Do ekranu poczÄ…tkowego</b>.
        <button onclick="this.parentElement.style.display='none'"
            style="margin-left:20px;background:#fbbc05;border:none;padding:4px 16px;border-radius:16px;font-weight:bold;cursor:pointer;">Zamknij</button>
    </div>

    <div id="error-banner"
        style="display:none;position:fixed;top:48px;left:50%;transform:translateX(-50%);background:#d93025;color:white;padding:12px 24px;border-radius:8px;z-index:10003;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.15);max-width:90vw;">
        <span id="error-message"></span>
        <button onclick="this.parentElement.style.display='none'"
            style="margin-left:18px;background:#fff;color:#d93025;border:none;padding:2px 12px;border-radius:12px;font-weight:bold;cursor:pointer;">Zamknij</button>
    </div>

    <div id="app">
        <header>
            <h1>NiezbÄ™dnik Instalatora</h1>
        </header>

        <main class="grid-container">

            <div class="tile" onclick="location.href='tools-src/nadajniki.html'">
                <span class="icon">ğŸ—¼</span>
                <span class="label">Kierunki do nadajnikÃ³w DVB-T</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/bibliotekaDVBT.html'">
                <span class="icon">ğŸ“º</span>
                <span class="label">Baza wiedzy DVB-T</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/satelity.html'">
                <span class="icon">ğŸ“¡</span>
                <span class="label">Kalkulator azymutu SAT</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/bibliotekaSAT.html'">
                <span class="icon">ğŸ›°ï¸</span>
                <span class="label">Baza wiedzy SAT</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/instrukcje.html'">
                <span class="icon">ğŸ“–</span>
                <span class="label">Instrukcje obsÅ‚ugi i dekoderÃ³w</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/cennik.html'">
                <span class="icon">ğŸ’°</span>
                <span class="label">Kalkulator usÅ‚ug i cennik</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/Jednostki.html'">
                <span class="icon">â†”ï¸</span>
                <span class="label">Przelicznik jednostek sygnaÅ‚u</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/internet.html'">
                <span class="icon">ğŸŒ</span>
                <span class="label">Internet, kable i LTE</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/notatki.html'">
                <span class="icon">ğŸ“</span>
                <span class="label">Notatnik instalatora</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/raporty.html'">
                <span class="icon">ğŸ“‹</span>
                <span class="label">Raporty z instalacji</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/magazyn.html'">
                <span class="icon">ğŸ“¦</span>
                <span class="label">Magazyn</span>
            </div>

            <div class="tile" onclick="lockAndExit()">
                <span class="icon">ğŸ”’</span>
                <span class="label">Wyloguj siÄ™</span>
            </div>
        </main>

        <footer style="text-align: center; color: gray; font-size: 10px; padding: 10px;">
            v<span id="app-version">1.x</span>, <span id="app-status">tryb sprawdzania...</span>
        </footer>
    </div>
</body>

<script>
    let backClickCounter = 0;




    function onDeviceReady() {
        // 1. WERSJA - automatycznie pobierana z manifest.json lub ze zmiennej CACHE_NAME w sw.js
        async function setAppVersion() {
            const el = document.getElementById('app-version');
            if (!el) return;
            // 1) SprÃ³buj pobraÄ‡ manifest.json i odczytaÄ‡ pole `version`
            try {
                const r = await fetch('manifest.json', { cache: 'no-store' });
                if (r.ok) {
                    const m = await r.json();
                    if (m.version) { el.innerText = m.version; return; }
                }
            } catch (e) { }
            // 2) Fallback: sprÃ³buj odczytaÄ‡ sw.js i dopasowaÄ‡ wersjÄ™ z CACHE_NAME
            try {
                const r2 = await fetch('sw.js', { cache: 'no-store' });
                if (r2.ok) {
                    const txt = await r2.text();
                    const re = /CACHE_NAME\s*=\s*['"]([a-zA-Z0-9\-_.]*v?(\d+(?:\.\d+)+))['"]/i;
                    const m = txt.match(re);
                    if (m && m[2]) { el.innerText = m[2]; return; }
                }
            } catch (e) { }
            // 3) Ostateczny fallback
            el.innerText = '1.0.0';
        }
        setAppVersion();

        const statusSpan = document.getElementById('app-status');

        // 2. STATUS SIECI
        function updateOnlineStatus() {

            if (navigator.onLine) {
                statusSpan.innerText = "Tryb ONLINE gotowy";
                statusSpan.style.color = "#03dac6";
                document.getElementById('offline-banner').style.display = 'none';
            } else {
                statusSpan.innerText = "Tryb OFFLINE gotowy";
                statusSpan.style.color = "gray";
                document.getElementById('offline-banner').style.display = 'block';
            }
        }
        updateOnlineStatus();

        document.addEventListener("offline", updateOnlineStatus, false);
        document.addEventListener("online", updateOnlineStatus, false);

        // 3. TEST POÅÄ„CZENIA Z INTERNETEM (opcjonalnie, moÅ¼na zostawiÄ‡ tylko navigator.onLine)
        function testInternetConnection() {
            fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' })
                .then(() => {
                    if (!navigator.onLine) return; // jeÅ›li systemowy offline, nie nadpisuj
                    statusSpan.innerText = "Tryb ONLINE gotowy";
                    statusSpan.style.color = "#03dac6";
                })
                .catch(() => {
                    statusSpan.innerText = "Tryb OFFLINE gotowy";
                    statusSpan.style.color = "gray";
                })
                .finally(() => {
                    updateOnlineStatus(); // zawsze synchronizuj po teÅ›cie
                });
        }
        testInternetConnection();
    }



    // Nasza wÅ‚asna, darmowa funkcja powiadomienia na ekranie
    function showToast(message) {
        // Usuwamy stare powiadomienie jeÅ›li jeszcze istnieje
        const oldToast = document.getElementById('custom-toast');
        if (oldToast) oldToast.remove();

        const statusDiv = document.createElement('div');
        statusDiv.id = 'custom-toast';
        statusDiv.style = "position:fixed; bottom:50px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:12px 25px; border-radius:25px; z-index:9999; font-size:14px; white-space:nowrap; border: 1px solid #444;";
        statusDiv.innerText = message;
        document.body.appendChild(statusDiv);

        // Animacja znikania
        setTimeout(() => {
            statusDiv.style.opacity = '0';
            statusDiv.style.transition = 'opacity 0.5s ease';
            setTimeout(() => statusDiv.remove(), 500);
        }, 2000);
    }

    function showOfflineBanner(show) {
        const banner = document.getElementById('offline-banner');
        const header = document.querySelector('header');
        // Ustaw margin-top headera zawsze na wysokoÅ›Ä‡ ramki, jeÅ›li ramka jest widoczna
        if (show) {
            banner.style.display = 'block';
            setTimeout(() => {
                if (header) header.style.marginTop = banner.offsetHeight + 'px';
            }, 10); // opÃ³Åºnienie na render
        } else {
            banner.style.display = 'none';
            if (header) header.style.marginTop = '';
        }

        // Dodatkowo, na zmianÄ™ orientacji i resize â€” popraw margin-top headera
        window.addEventListener('resize', () => {
            if (banner.style.display === 'block' && header) {
                header.style.marginTop = banner.offsetHeight + 'px';
            }
        });
    }

    // Dla pewnoÅ›ci: po powrocie na stronÄ™/wybudzeniu â€” odÅ›wieÅ¼ status i ukÅ‚ad
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            if (typeof updateOnlineStatus === 'function') updateOnlineStatus();
            if (typeof showOfflineBanner === 'function') showOfflineBanner(!navigator.onLine ? true : false);
        }
    });
    window.addEventListener('pageshow', () => {
        if (typeof updateOnlineStatus === 'function') updateOnlineStatus();
        if (typeof showOfflineBanner === 'function') showOfflineBanner(!navigator.onLine ? true : false);
    });


    function showIosInstallBanner() {
        const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        if (isIos && !isStandalone) {
            document.getElementById('ios-install-banner').style.display = 'block';
        }
    }





    // Funkcja stopki (zostaje, by pokazywaÄ‡ wersjÄ™ z manifestu)
    async function setAppVersion() {
        const el = document.getElementById('app-version');
        if (el) el.innerText = APP_CONFIG.VERSION;
    }

    //Po zaÅ‚adaniu strony, inicjalizujemy zabezpieczenia, ustawiamy status sieci i wersjÄ™ aplikacji
    window.addEventListener('load', async () => {
        //await initSecurity();
        initApp();
        onDeviceReady();
        setAppVersion();
        showIosInstallBanner();
    });

    // OstrzeÅ¼enie przed zamkniÄ™ciem karty, jeÅ›li uÅ¼ytkownik jest zalogowany
    window.addEventListener('beforeunload', (event) => {
        const pin = sessionStorage.getItem('user_pin');
        // JeÅ›li PIN jest w sesji, oznacza to, Å¼e baza robocza jest "odkryta"
        if (pin) {
            event.preventDefault();
            // WiÄ™kszoÅ›Ä‡ nowoczesnych przeglÄ…darek wyÅ›wietli wÅ‚asny tekst, 
            // ale ustawienie returnValue jest wymagane do aktywacji okna.
            event.returnValue = 'Uwaga! Masz aktywne dane. UÅ¼yj przycisku WYLOGUJ, aby je bezpiecznie zaszyfrowaÄ‡.';
        }
    });


</script>

</html>