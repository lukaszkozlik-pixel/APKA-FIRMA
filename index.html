<!DOCTYPE html>
<html lang="pl">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="config.js"></script> </head>
    <script>
        // Ustaw zawsze motyw jasny
        window.addEventListener('DOMContentLoaded', () => {
            document.documentElement.setAttribute('data-theme', 'light');
        });

        // Deklarujemy zmiennƒÖ globalnie, aby updateApp() mia≈Ça do niej dostƒôp
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    console.log('SW dzia≈Ça w trybie: Najpierw Sieƒá');
                });
            });
        }

    </script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <script>
        // Blokada zmiany orientacji ekranu na portrait
        if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('portrait').catch(()=>{});
        } else if (window.screen.lockOrientation) {
            window.screen.lockOrientation('portrait');
        }
        </script>
    <title>Instalator Pro</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!--skrypt pierwszego LOGOWWNIA-->
    <div id="app-lock-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; flex-direction:column; align-items:center; justify-content:center; padding:20px; text-align:center;">
    <div id="lock-icon" style="font-size: 4rem; margin-bottom: 20px;">üîí</div>
    <h2 id="lock-title">Zabezpiecz dostƒôp</h2>
    <p id="lock-msg">Wybierz metodƒô ochrony swoich danych.</p>
    
    <div id="setup-section" style="display:none; width:100%; max-width:300px;">
        <input type="password" id="setup-pin" pattern="[0-9]*" inputmode="numeric" placeholder="Ustaw 4-cyfrowy PIN" maxlength="4" style="width:100%; padding:15px; font-size:1.2rem; border-radius:10px; border:1px solid #ccc; margin-bottom:10px; text-align:center;">
        <button onclick="saveInitialPin()" style="width:100%; padding:15px; background:#1a73e8; color:white; border:none; border-radius:10px; font-weight:bold;">ZAPISZ PIN</button>
    </div>

    <div id="login-section" style="display:none; width:100%; max-width:300px;">
        <input type="password" id="login-pin" pattern="[0-9]*" inputmode="numeric" placeholder="Wpisz PIN" maxlength="4" style="width:100%; padding:15px; font-size:1.5rem; border-radius:10px; border:1px solid #ccc; margin-bottom:15px; text-align:center;">
        <button onclick="checkPin()" style="width:100%; padding:15px; background:#34a853; color:white; border:none; border-radius:10px; font-weight:bold; margin-bottom:10px;">ODBLOKUJ PINEM</button>
        <button id="btn-biometric" onclick="tryBiometry()" style="display:none; width:100%; padding:15px; background:none; border:2px solid #1a73e8; color:#1a73e8; border-radius:10px; font-weight:bold;">U≈ªYJ BIOMETRII ‚òùÔ∏è</button>
    </div>
    </div>
   <!--skrypt LOGOWWNIA-->

    <div id="offline-banner" style="display:none;position:fixed;top:0;left:0;width:100vw;background:#d93025;color:white;text-align:center;padding:12px 0;z-index:10001;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.15);">
        Brak po≈ÇƒÖczenia z internetem ‚Äì aplikacja dzia≈Ça w trybie offline.
    </div>

    <div id="ios-install-banner" style="display:none;position:fixed;bottom:0;left:0;width:100vw;background:#fffbe6;color:#202124;text-align:center;padding:14px 10px 14px 50px;z-index:10002;font-weight:500;box-shadow:0 -2px 8px rgba(0,0,0,0.10);border-top:2px solid #fbbc05;font-size:1rem;align-items:center;">
        Aby zainstalowaƒá aplikacjƒô na iPhonie: kliknij <b>Udostƒôpnij</b>  i wybierz <b>Do ekranu poczƒÖtkowego</b>.
        <button onclick="this.parentElement.style.display='none'" style="margin-left:20px;background:#fbbc05;border:none;padding:4px 16px;border-radius:16px;font-weight:bold;cursor:pointer;">Zamknij</button>
    </div>

    <div id="error-banner" style="display:none;position:fixed;top:48px;left:50%;transform:translateX(-50%);background:#d93025;color:white;padding:12px 24px;border-radius:8px;z-index:10003;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.15);max-width:90vw;">
        <span id="error-message"></span>
        <button onclick="this.parentElement.style.display='none'" style="margin-left:18px;background:#fff;color:#d93025;border:none;padding:2px 12px;border-radius:12px;font-weight:bold;cursor:pointer;">Zamknij</button>
    </div>

    <div id="app">
        <header>
            <h1>Niezbƒôdnik Instalatora</h1>
        </header>

        <main class="grid-container">
           
            <div class="tile" onclick="location.href='tools-src/nadajniki.html'">
                <span class="icon">üóº</span>
                <span class="label">Kierunki do nadajnik√≥w DVB-T</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/bibliotekaDVBT.html'">
                <span class="icon">üì∫</span>
                <span class="label">Baza wiedzy DVB-T</span>
            </div>
             <div class="tile" onclick="location.href='tools-src/satelity.html'">
                <span class="icon">üì°</span>
                <span class="label">Kalkulator azymutu SAT</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/bibliotekaSAT.html'">
                <span class="icon">üõ∞Ô∏è</span>
                <span class="label">Baza wiedzy SAT</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/instrukcje.html'">
                <span class="icon">üìñ</span>
                <span class="label">Instrukcje obs≈Çugi i dekoder√≥w</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/cennik.html'">
                <span class="icon">üí∞</span>
                <span class="label">Kalkulator us≈Çug i cennik</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/Jednostki.html'">
                <span class="icon">‚ÜîÔ∏è</span>
                <span class="label">Przelicznik jednostek sygna≈Çu</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/internet.html'">
                <span class="icon">üåê</span>
                <span class="label">Internet, kable i LTE</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/notatki.html'">
                <span class="icon">üìù</span>
                <span class="label">Notatnik instalatora</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/raporty.html'">
                <span class="icon">üìã</span>
                <span class="label">Raporty z instalacji</span>
            </div>
            <div class="tile" onclick="location.href='tools-src/magazyn.html'">
                <span class="icon">üì¶</span>
                <span class="label">Magazyn</span>
            </div>
             <div class="tile" onclick="location.href='tools-src/settings.html'">
                <span class="icon">‚öôÔ∏è</span>
                <span class="label">Ustawienia</span>
            </div>
        </main>

        <footer style="text-align: center; color: gray; font-size: 10px; padding: 10px;">
            v<span id="app-version">1.x</span>, <span id="app-status">tryb sprawdzania...</span>
        </footer>
    </div>
</body>

    <script>
        let backClickCounter = 0;

    
       
        
        function onDeviceReady() {
            // 1. WERSJA - automatycznie pobierana z manifest.json lub ze zmiennej CACHE_NAME w sw.js
            async function setAppVersion() {
                const el = document.getElementById('app-version');
                if (!el) return;
                // 1) Spr√≥buj pobraƒá manifest.json i odczytaƒá pole `version`
                try {
                    const r = await fetch('manifest.json', {cache: 'no-store'});
                    if (r.ok) {
                        const m = await r.json();
                        if (m.version) { el.innerText = m.version; return; }
                    }
                } catch(e){}
                // 2) Fallback: spr√≥buj odczytaƒá sw.js i dopasowaƒá wersjƒô z CACHE_NAME
                try {
                    const r2 = await fetch('sw.js', {cache: 'no-store'});
                    if (r2.ok) {
                        const txt = await r2.text();
                        const re = /CACHE_NAME\s*=\s*['"]([a-zA-Z0-9\-_.]*v?(\d+(?:\.\d+)+))['"]/i;
                        const m = txt.match(re);
                        if (m && m[2]) { el.innerText = m[2]; return; }
                    }
                } catch(e){}
                // 3) Ostateczny fallback
                el.innerText = '1.0.0';
            }
            setAppVersion();
        
            const statusSpan = document.getElementById('app-status');
        
            // 2. STATUS SIECI
            function updateOnlineStatus() {

                if (navigator.onLine) {
                    statusSpan.innerText = "Tryb ONLINE gotowy";
                    statusSpan.style.color = "#03dac6";
                    document.getElementById('offline-banner').style.display = 'none';
                } else {
                    statusSpan.innerText = "Tryb OFFLINE gotowy";
                    statusSpan.style.color = "gray";
                    document.getElementById('offline-banner').style.display = 'block';
                }
            }
            updateOnlineStatus();

            document.addEventListener("offline", updateOnlineStatus, false);
            document.addEventListener("online", updateOnlineStatus, false);

            // 3. TEST PO≈ÅƒÑCZENIA Z INTERNETEM (opcjonalnie, mo≈ºna zostawiƒá tylko navigator.onLine)
            function testInternetConnection() {
                fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' })
                    .then(() => {
                        if (!navigator.onLine) return; // je≈õli systemowy offline, nie nadpisuj
                        statusSpan.innerText = "Tryb ONLINE gotowy";
                        statusSpan.style.color = "#03dac6";
                    })
                    .catch(() => {
                        statusSpan.innerText = "Tryb OFFLINE gotowy";
                        statusSpan.style.color = "gray";
                    })
                    .finally(() => {
                        updateOnlineStatus(); // zawsze synchronizuj po te≈õcie
                    });
            }
            testInternetConnection();

            // 4. UKRYTY PRYCISK DO RESETU - licznik klikniƒôƒá w stopkƒô
            const footer = document.querySelector('footer');
            if (footer) {
                footer.style.cursor = 'pointer';
                footer.setAttribute('title', 'Kliknij kilka razy, aby zresetowaƒá aplikacjƒô');

                footer.addEventListener('click', () => {
                    backClickCounter++;
                    // opcjonalnie pokazujemy kr√≥tkie powiadomienie
                    showToast(`Klikniƒôcia: ${backClickCounter}/5`);
                    if (backClickCounter >= 5) {
                        // potwierdzenie u≈ºytkownika przed trwa≈Çym usuniƒôciem
                        if (confirm('Czy na pewno chcesz zresetowaƒá aplikacjƒô? To usunie wszystkie dane i cache.')) {
                            // usu≈Ñ cache'y service workera
                            if ('caches' in window) {
                                caches.keys().then(names => {
                                    names.forEach(name => caches.delete(name));
                                });
                            }
                            // wyrejestruj service workera (je≈õli jest)
                            if (navigator.serviceWorker && navigator.serviceWorker.getRegistrations) {
                                navigator.serviceWorker.getRegistrations().then(regs => {
                                    regs.forEach(r => r.unregister());
                                }).catch(()=>{});
                            }
                            // wyczy≈õƒá localStorage
                            try { localStorage.clear(); } catch(e) {}
                            // zresetuj licznik i prze≈Çaduj stronƒô
                            backClickCounter = 0;
                            location.reload();
                        } else {
                            backClickCounter = 0; // anulowano, resetujemy licznik
                        }
                    }
                });

                // Zeruj licznik kiedy u≈ºytkownik opuszcza aplikacjƒô lub ukrywa kartƒô
                window.addEventListener('pagehide', () => { backClickCounter = 0; });
                window.addEventListener('beforeunload', () => { backClickCounter = 0; });
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) backClickCounter = 0;
                });
            }
        }


        
        // Nasza w≈Çasna, darmowa funkcja powiadomienia na ekranie
        function showToast(message) {
            // Usuwamy stare powiadomienie je≈õli jeszcze istnieje
            const oldToast = document.getElementById('custom-toast');
            if (oldToast) oldToast.remove();
        
            const statusDiv = document.createElement('div');
            statusDiv.id = 'custom-toast';
            statusDiv.style = "position:fixed; bottom:50px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:12px 25px; border-radius:25px; z-index:9999; font-size:14px; white-space:nowrap; border: 1px solid #444;";
            statusDiv.innerText = message;
            document.body.appendChild(statusDiv);
        
            // Animacja znikania
            setTimeout(() => {
                statusDiv.style.opacity = '0';
                statusDiv.style.transition = 'opacity 0.5s ease';
                setTimeout(() => statusDiv.remove(), 500);
            }, 2000);
        }

        function showOfflineBanner(show) {
            const banner = document.getElementById('offline-banner');
            const header = document.querySelector('header');
            // Ustaw margin-top headera zawsze na wysoko≈õƒá ramki, je≈õli ramka jest widoczna
            if (show) {
                banner.style.display = 'block';
                setTimeout(() => {
                    if(header) header.style.marginTop = banner.offsetHeight + 'px';
                }, 10); // op√≥≈∫nienie na render
            } else {
                banner.style.display = 'none';
                if(header) header.style.marginTop = '';
            }

            // Dodatkowo, na zmianƒô orientacji i resize ‚Äî popraw margin-top headera
            window.addEventListener('resize', () => {
                if (banner.style.display === 'block' && header) {
                    header.style.marginTop = banner.offsetHeight + 'px';
                }
            });
        }

        // Dla pewno≈õci: po powrocie na stronƒô/wybudzeniu ‚Äî od≈õwie≈º status i uk≈Çad
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                if (typeof updateOnlineStatus === 'function') updateOnlineStatus();
                if (typeof showOfflineBanner === 'function') showOfflineBanner(!navigator.onLine ? true : false);
            }
        });
        window.addEventListener('pageshow', () => {
            if (typeof updateOnlineStatus === 'function') updateOnlineStatus();
            if (typeof showOfflineBanner === 'function') showOfflineBanner(!navigator.onLine ? true : false);
        });
        

        function showIosInstallBanner() {
            const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            if (isIos && !isStandalone) {
                document.getElementById('ios-install-banner').style.display = 'block';
            }
        }
      
        

        // Magazyn i inne narzƒôdzia korzystajƒÖ z IndexedDB ‚Äî upewniamy siƒô, ≈ºe baza danych jest gotowa do u≈ºycia
        const request = indexedDB.open(APP_CONFIG.DB_NAME, APP_CONFIG.DB_VERSION); // Wersja 3 dla ustawie≈Ñ

        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains("raporty")) db.createObjectStore("raporty", { keyPath: "id", autoIncrement: true });
            if (!db.objectStoreNames.contains("magazyn")) db.createObjectStore("magazyn", { keyPath: "name" });
            if (!db.objectStoreNames.contains("settings")) db.createObjectStore("settings", { keyPath: "key" });
        };

        // Inicjalizacja zabezpiecze≈Ñ (PIN/biometria) przy starcie aplikacji    
 
        async function initSecurity() {
            // Sprawdzenie sesji - je≈õli zalogowany w tej karcie i nie wygas≈Ça, pokazujemy apkƒô
            const auth = sessionStorage.getItem('app_authenticated');
            const lastAuth = sessionStorage.getItem('app_last_auth');
            const now = Date.now();
            const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minut
            if (auth === 'true' && lastAuth && (now - parseInt(lastAuth, 10) < SESSION_TIMEOUT)) {
                document.getElementById('app-lock-overlay').style.display = 'none';
                // Od≈õwie≈º czas ostatniej aktywno≈õci
                sessionStorage.setItem('app_last_auth', now.toString());
                return Promise.resolve();
            } else {
                sessionStorage.removeItem('app_authenticated');
                sessionStorage.removeItem('app_last_auth');
            }

            const db = await openDB();
            const settings = await getSetting(db, 'user_security');
            const overlay = document.getElementById('app-lock-overlay');

            if (!settings) {
                // Je≈õli brak skonfigurowanego PINu, apka jest otwarta
                overlay.style.display = 'none';
                return Promise.resolve();
            } else {
                // Blokujemy ekran i czekamy na PIN/Biometriƒô
                overlay.style.display = 'flex';
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('lock-title').innerText = "Zablokowano";
                
                if (settings.biometryEnabled) {
                    document.getElementById('btn-biometric').style.display = 'block';
                    tryBiometry(); 
                }
                
                // Zwracamy Promise, kt√≥ry "wisi", dop√≥ki u≈ºytkownik siƒô nie zaloguje
                return new Promise((resolve) => {
                    window.resolveLogin = resolve; // Wywo≈Çamy to po poprawnym checkPin()
                });
            }
        }

        // Funkcja weryfikacji PINu z obs≈ÇugƒÖ sesji i kodu ratunkowego
        async function checkPin() {
            const input = document.getElementById('login-pin').value.toUpperCase();
            const db = await openDB();
            const settings = await getSetting(db, 'user_security');

            // Logowanie poprawne (PIN lub Kod Ratunkowy z bazy)
            if (input === settings.pin || (settings.recoveryKey && input === settings.recoveryKey)) {
                sessionStorage.setItem('app_authenticated', 'true'); // USTAWIENIE SESJI
                sessionStorage.setItem('app_last_auth', Date.now().toString()); // Zapisz czas logowania
                document.getElementById('app-lock-overlay').style.display = 'none';
                
                if (input === settings.recoveryKey) {
                    alert("U≈ºyto kodu ratunkowego. Zmie≈Ñ sw√≥j PIN w ustawieniach.");
                }
            } else {
                alert("B≈Çƒôdny PIN!");
                document.getElementById('login-pin').value = '';
            }
        }

        // Funkcja zapisu PINu (wywo≈Çywana tylko przy pierwszej konfiguracji)
        async function saveInitialPin() {
            const pin = document.getElementById('setup-pin').value;
            if (pin.length < 4) return alert("PIN musi mieƒá 4 cyfry");

            // Generujemy unikalny Kod Ratunkowy (bezpieczniejszy ni≈º sta≈Çy Master PIN)
            const recoveryKey = Math.random().toString(36).substring(2, 10).toUpperCase();

            let bioEnabled = false;
            if (window.PublicKeyCredential) {
                bioEnabled = confirm("Czy chcesz u≈ºywaƒá biometrii (odcisk palca)?");
            }

            const db = await openDB();
            const tx = db.transaction("settings", "readwrite");
            tx.objectStore("settings").put({ 
                key: 'user_security', 
                pin: pin, 
                biometryEnabled: bioEnabled,
                recoveryKey: recoveryKey 
            });
            
            tx.oncomplete = () => {
                sessionStorage.setItem('app_authenticated', 'true');
                alert("Zabezpieczenia skonfigurowane!\n\nKOD RATUNKOWY: " + recoveryKey + "\nZapisz go w bezpiecznym miejscu!");
                location.reload();
            };
        }

        async function checkPin() {
            const input = document.getElementById('login-pin').value.toUpperCase();
            const db = await openDB();
            const settings = await getSetting(db, 'user_security');

            if (input === settings.pin || (settings.recoveryKey && input === settings.recoveryKey)) {
                sessionStorage.setItem('app_authenticated', 'true');
                document.getElementById('app-lock-overlay').style.display = 'none';
                
                // POWIADOMIENIE RESZTY KODU, ≈ªE MO≈ªNA STARTOWAƒÜ
                if (window.resolveLogin) window.resolveLogin(); 
                
                if (input === settings.recoveryKey) {
                    alert("U≈ºyto kodu ratunkowego! Zmie≈Ñ PIN w ustawieniach.");
                }
            } else {
                alert("B≈Çƒôdny PIN!");
                document.getElementById('login-pin').value = '';
            }
        }

        // Funkcja do obs≈Çugi logowania biometrycznego
        async function tryBiometry() {
            const db = await openDB();
            const settings = await getSetting(db, 'user_security');
            
            if (!settings || !settings.credentialId) return;

            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            // Przekszta≈Çcamy zapisany ID z powrotem na format binarny
            const credentialId = Uint8Array.from(atob(settings.credentialId), c => c.charCodeAt(0));

            const getCredentialOptions = {
                publicKey: {
                    challenge: challenge,
                    allowCredentials: [{
                        id: credentialId,
                        type: 'public-key',
                        transports: ['internal'],
                    }],
                    userVerification: "required",
                    timeout: 60000,
                }
            };

            try {
                const assertion = await navigator.credentials.get(getCredentialOptions);
                if (assertion) {
                    // Sukces! Biometria potwierdzona sprzƒôtowo
                    sessionStorage.setItem('app_authenticated', 'true');
                    sessionStorage.setItem('app_last_auth', Date.now().toString());
                    document.getElementById('app-lock-overlay').style.display = 'none';
                    if (window.resolveLogin) window.resolveLogin();
                }
            } catch (err) {
                console.log("Logowanie biometryczne przerwane lub b≈ÇƒÖd:", err);
            }
        }

        // Pomocnicze funkcje IndexedDB
        function openDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(APP_CONFIG.DB_NAME, APP_CONFIG.DB_VERSION);
                
                req.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains("raporty")) d.createObjectStore("raporty", { keyPath: "id", autoIncrement: true });
                    if (!d.objectStoreNames.contains("magazyn")) d.createObjectStore("magazyn", { keyPath: "name" });
                    if (!d.objectStoreNames.contains("settings")) d.createObjectStore("settings", { keyPath: "key" });
                };

                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
                
                // Wa≈ºne: obs≈Çuga blokady, gdy inna karta trzyma starƒÖ wersjƒô bazy
                req.onblocked = () => {
                    alert("Zamknij inne karty aplikacji, aby doko≈Ñczyƒá aktualizacjƒô!");
                };
            });
        }

        // Funkcja do pobierania ustawie≈Ñ z IndexedDB
        function getSetting(db, key) {
            return new Promise(res => {
                db.transaction("settings").objectStore("settings").get(key).onsuccess = e => res(e.target.result);
            });
        }


        // Funkcja stopki (zostaje, by pokazywaƒá wersjƒô z manifestu)
        async function setAppVersion() {
            const el = document.getElementById('app-version');
            if (el) el.innerText = APP_CONFIG.VERSION;
        }

        //Po za≈Çadaniu strony, inicjalizujemy zabezpieczenia, ustawiamy status sieci i wersjƒô aplikacji
        window.addEventListener('load',async () => {
            await initSecurity();
            onDeviceReady();
            setAppVersion();
            showIosInstallBanner();
            // Monitoruj minimalizowanie/ukrywanie aplikacji
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Przy ukryciu aplikacji, wyloguj u≈ºytkownika
                    sessionStorage.removeItem('app_authenticated');
                    sessionStorage.removeItem('app_last_auth');
                }
            });
            window.addEventListener('beforeunload', () => {
                sessionStorage.removeItem('app_authenticated');
                sessionStorage.removeItem('app_last_auth');
            });
            // Opcjonalnie: przy powrocie sprawd≈∫ czy sesja nie wygas≈Ça
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden) {
                    await initSecurity();
                }
            });
            window.addEventListener('pageshow', async () => {
                await initSecurity();
            });
        }); 

        
    </script>
</html>